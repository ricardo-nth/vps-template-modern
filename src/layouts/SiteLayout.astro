---
/**
 * SiteLayout.astro - Outer/Presentation Layout
 *
 * This layout wraps TechnicalLayout and adds visual structure:
 * - Header navigation
 * - Footer
 * - Main content area
 * - Page-specific styling
 *
 * This demonstrates the two-tier layout pattern:
 * TechnicalLayout (technical concerns) → SiteLayout (presentation) → Page Content
 *
 * Pages pass SEO and Schema data as props. SiteLayout renders the components.
 *
 * Benefits:
 * - Separation of concerns (technical vs. presentation)
 * - Reusability (can create BlogLayout, LandingLayout, etc. using same TechnicalLayout)
 * - Easier maintenance
 * - Clear responsibility boundaries
 * - Clean page templates (no component rendering in page body)
 */

import TechnicalLayout from './TechnicalLayout.astro';
import { SEO } from 'astro-seo';
import { Schema } from 'astro-seo-schema';
import type { Thing } from 'schema-dts';
import { careProfileConfig } from '@/config/site';

// ============================================================================
// COMPONENT IMPORTS
// ============================================================================
import Header from '../components/Header.astro';
import SecondaryNav from '../components/SecondaryNav.astro';
import Footer from '../components/Footer.astro';
import CareTypeControlBar from '../components/CareTypeControlBar.astro';

// Define props interface
interface Props {
  // Page Metadata (simplified single object)
  metadata?: {
    title: string;
    description?: string;
    index?: boolean; // Default: true (index, follow) | false (noindex, nofollow)
    schema?: Thing; // Optional page-specific schema
  };

  // Layout-specific Props
  showHeader?: boolean;
  showFooter?: boolean;
  containerClass?: string;
}

// Destructure props with defaults
const {
  metadata,
  showHeader = true,
  showFooter = true,
  containerClass = '',
} = Astro.props;

// Generate canonical URL from current page
const canonical = new URL(Astro.url.pathname, Astro.site).toString();

// Build SEO props from metadata
const seoProps = metadata ? {
  title: metadata.title,
  description: metadata.description,
  canonical: canonical,
  extend: {
    meta: [
      { name: 'robots', content: metadata.index !== false ? 'index, follow' : 'noindex, nofollow' },
    ],
  },
} : undefined;

// Use schema from metadata if provided
const schemaProps = metadata?.schema;
const { previewEnabled, defaultProfile, storageKey } = careProfileConfig;
---

<!-- Wrap everything in TechnicalLayout for SEO and technical concerns -->
<TechnicalLayout>
  <!-- Render SEO component if seoProps provided -->
  {seoProps && (
    <SEO slot="seo" {...seoProps} />
  )}

  <!-- Render Schema component if schemaProps provided -->
  {schemaProps && (
    <Schema slot="schema" item={schemaProps} />
  )}

  <!-- Page Structure -->
  <div class="min-h-screen flex flex-col">

    <!-- Header Navigation (optional) -->
    {showHeader && (
      <>
        {previewEnabled && <CareTypeControlBar />}
        <Header />
        <SecondaryNav />
      </>
    )}

    <!-- Main Content Area -->
    <main class={`flex-1 ${containerClass}`}>
      <!-- Slot for page content -->
      <slot />
    </main>

    <script is:inline define:vars={{ previewEnabled, defaultProfile, storageKey }}>
      (() => {
        const normalizeProfile = (profile) => {
          return profile === 'dom-care' ? 'dom-care' : 'supported-living';
        };

        const getCurrentProfile = () => {
          const profile = document.documentElement.dataset.careProfile;
          if (!profile) return null;
          return normalizeProfile(profile);
        };

        const apply = (profile) => {
          const current = normalizeProfile(profile);
          document.documentElement.dataset.careProfile = current;
          const groups = document.querySelectorAll('[data-care-profile-switcher]');

          groups.forEach((group) => {
            const panels = group.querySelectorAll('[data-care-profile-panel]');
            panels.forEach((panel) => {
              const match = panel.getAttribute('data-care-profile-panel') === current;
              panel.classList.toggle('hidden', !match);
              panel.setAttribute('aria-hidden', String(!match));
            });

            const activePanel = group.querySelector(`[data-care-profile-panel="${current}"]`);
            if (activePanel && group.firstElementChild !== activePanel) {
              group.prepend(activePanel);
            }
          });
        };

        if (!previewEnabled) {
          apply(defaultProfile);
          return;
        }

        let initial = defaultProfile;
        try {
          initial = localStorage.getItem(storageKey) || defaultProfile;
        } catch {
          initial = defaultProfile;
        }

        apply(getCurrentProfile() ?? initial);
        window.addEventListener('care-profile-change', (event) => {
          apply(event.detail?.profile || defaultProfile);
        });
      })();
    </script>

    <!-- Footer (optional) -->
    {showFooter && <Footer />}
  </div>
</TechnicalLayout>
